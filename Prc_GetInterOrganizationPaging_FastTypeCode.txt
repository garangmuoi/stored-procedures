USE [DHTN-2025]
GO

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE [edoc].[Prc_GetInterOrganizationPaging_FastTypeCode]
    @PageNumber INT = 1,
    @PageSize INT = 10,
    @SearchText NVARCHAR(250) = NULL,
    @OrgType NVARCHAR(MAX) = NULL
AS
BEGIN
    SET NOCOUNT ON;

    -- Tạo bảng tạm vật lý
    CREATE TABLE #OrgTypeTable (OrgType INT);
    CREATE TABLE #SearchIds (Code NVARCHAR(250));


    IF @OrgType IS NOT NULL AND @OrgType <> '-1000'
    BEGIN
        INSERT INTO #OrgTypeTable (OrgType)
        SELECT CAST(value AS INT)
        FROM dbo.SplitString(@OrgType, ',');
    END
    
    IF @SearchText IS NOT NULL
    BEGIN
        INSERT INTO #SearchIds (Code)
        SELECT LTRIM(RTRIM(value))
        FROM dbo.SplitString(@SearchText, ',')
        WHERE LTRIM(RTRIM(value)) <> '';
    END

    SELECT
        OrganID,
        OrganAdd,
        OrganName,
        FastTypeCode,
        InOrder
    FROM [DHTN-2025].edoc.InterOrganization
    WHERE 
        IsDeleted = 0
        AND (
            (@OrgType = '-1000' AND OrganID IN (SELECT Code FROM #SearchIds))
            OR
            (@OrgType <> '-1000' AND
                (
                @SearchText IS NULL
                OR (dbo.fRemoveDiacritics(FastTypeCode) IN (SELECT dbo.fRemoveDiacritics(Code) FROM #SearchIds))
                )
                AND (@OrgType IS NULL OR OrgType IN (SELECT OrgType FROM #OrgTypeTable))
            )
        )
    ORDER BY 
        InOrder ASC

    DROP TABLE #OrgTypeTable;
    DROP TABLE #SearchIds;
END