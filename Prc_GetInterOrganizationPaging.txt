USE [DHTN-2025]
GO
/****** Object:  StoredProcedure [edoc].[Prc_GetInterOrganizationPaging]    Script Date: 09/30/2025 10:04:38 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE [edoc].[Prc_GetInterOrganizationPaging]
    @SearchText NVARCHAR(250) = NULL,
    @PageNumber INT = 1,
    @PageSize INT = 10,
    @OrgType NVARCHAR(MAX) = NULL
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @TotalRowCount INT;

    -- Tạo bảng tạm vật lý
    CREATE TABLE #OrgTypeTable (OrgType INT);
    CREATE TABLE #SearchIds (OrganID NVARCHAR(250));


    IF @OrgType IS NOT NULL AND @OrgType <> '-1000'
    BEGIN
        INSERT INTO #OrgTypeTable (OrgType)
        SELECT CAST(value AS INT)
        FROM dbo.SplitString(@OrgType, ',');
    END
    
    -- Nếu OrgType = -1000 thì split SearchText để lấy danh sách OrganID
    IF @OrgType = '-1000' AND @SearchText IS NOT NULL
    BEGIN
        INSERT INTO #SearchIds (OrganID)
        SELECT LTRIM(RTRIM(value))
        FROM dbo.SplitString(@SearchText, ',')
        WHERE LTRIM(RTRIM(value)) <> '';
    END

    -- Đếm tổng số dòng
    SELECT @TotalRowCount = COUNT(*)
    FROM [DHTN-2025].edoc.InterOrganization
    WHERE 
        IsDeleted = 0
        AND (
            (@OrgType = '-1000' AND OrganID IN (SELECT OrganID FROM #SearchIds))
            OR
            (@OrgType <> '-1000' AND 
                (@SearchText IS NULL OR 
                (
                    dbo.fRemoveDiacritics(OrganName) = dbo.fRemoveDiacritics(@SearchText)
                    OR dbo.fRemoveDiacritics(OrganName) LIKE dbo.fRemoveDiacritics(@SearchText) + ' %'
                    OR dbo.fRemoveDiacritics(OrganName) LIKE '% ' + dbo.fRemoveDiacritics(@SearchText)
                    OR dbo.fRemoveDiacritics(OrganName) LIKE '% ' + dbo.fRemoveDiacritics(@SearchText) + ' %'
                ) OR
                (
                    dbo.fRemoveDiacritics(FastTypeCode) = dbo.fRemoveDiacritics(@SearchText)
                    OR dbo.fRemoveDiacritics(FastTypeCode) LIKE dbo.fRemoveDiacritics(@SearchText) + ' %'
                    OR dbo.fRemoveDiacritics(FastTypeCode) LIKE '% ' + dbo.fRemoveDiacritics(@SearchText)
                    OR dbo.fRemoveDiacritics(FastTypeCode) LIKE '% ' + dbo.fRemoveDiacritics(@SearchText) + ' %'
                )
                )
                AND (@OrgType IS NULL OR OrgType IN (SELECT OrgType FROM #OrgTypeTable))
            )
        );

    -- Lấy dữ liệu phân trang
    SELECT
        OrganID,
        OrganAdd,
        OrganName,
        FastTypeCode,
        InOrder,
        @PageNumber AS PageNumber,
        @PageSize AS PageSize,
        CEILING(CAST(@TotalRowCount AS DECIMAL) / @PageSize) AS Total
    FROM [DHTN-2025].edoc.InterOrganization
    WHERE 
        IsDeleted = 0
        AND (
            (@OrgType = '-1000' AND OrganID IN (SELECT OrganID FROM #SearchIds))
            OR
            (@OrgType <> '-1000' AND 
                (@SearchText IS NULL OR 
                (
                    dbo.fRemoveDiacritics(OrganName) = dbo.fRemoveDiacritics(@SearchText)
                    OR dbo.fRemoveDiacritics(OrganName) LIKE dbo.fRemoveDiacritics(@SearchText) + ' %'
                    OR dbo.fRemoveDiacritics(OrganName) LIKE '% ' + dbo.fRemoveDiacritics(@SearchText)
                    OR dbo.fRemoveDiacritics(OrganName) LIKE '% ' + dbo.fRemoveDiacritics(@SearchText) + ' %'
                ) OR
                (
                    dbo.fRemoveDiacritics(FastTypeCode) = dbo.fRemoveDiacritics(@SearchText)
                    OR dbo.fRemoveDiacritics(FastTypeCode) LIKE dbo.fRemoveDiacritics(@SearchText) + ' %'
                    OR dbo.fRemoveDiacritics(FastTypeCode) LIKE '% ' + dbo.fRemoveDiacritics(@SearchText)
                    OR dbo.fRemoveDiacritics(FastTypeCode) LIKE '% ' + dbo.fRemoveDiacritics(@SearchText) + ' %'
                )
                )
                AND (@OrgType IS NULL OR OrgType IN (SELECT OrgType FROM #OrgTypeTable))
            )
        )
    ORDER BY 
        InOrder ASC,
        OrganID ASC
    OFFSET (@PageNumber - 1) * @PageSize ROWS
    FETCH NEXT @PageSize ROWS ONLY;

    DROP TABLE #OrgTypeTable;
    DROP TABLE #SearchIds;
END